<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.linghang.we_talk.mapper.CommentMapper">

    <!-- 查询帖子所有评论 -->
    <select id="findByPostId" resultType="com.linghang.we_talk.entity.Comment">
        SELECT
            c.*,
            u.username as user_name,
            ru.username as reply_to_user_name,
            rc.content as reply_to_comment_content
        FROM comment c
                 LEFT JOIN user u ON c.user_id = u.id
                 LEFT JOIN user ru ON c.reply_to_user_id = ru.id
                 LEFT JOIN comment rc ON c.reply_to_comment_id = rc.id
        WHERE c.post_id = #{postId}
        ORDER BY
            COALESCE(c.parent_id, c.id) DESC,
            c.created_at ASC
    </select>

    <!-- 分页查询一级评论 -->
    <select id="findRootCommentsByPage" resultType="com.linghang.we_talk.entity.Comment">
        SELECT
            c.*,
            u.username as user_name
        FROM comment c
                 LEFT JOIN user u ON c.user_id = u.id
        WHERE c.post_id = #{postId}
          AND c.parent_id IS NULL
        ORDER BY c.created_at DESC
            LIMIT #{offset}, #{limit}
    </select>

    <!-- 查询二级评论 -->
    <select id="findRepliesByParentId" resultType="com.linghang.we_talk.entity.Comment">
        SELECT
            c.*,
            u.username as user_name,
            ru.username as reply_to_user_name,
            rc.content as reply_to_comment_content
        FROM comment c
                 LEFT JOIN user u ON c.user_id = u.id
                 LEFT JOIN user ru ON c.reply_to_user_id = ru.id
                 LEFT JOIN comment rc ON c.reply_to_comment_id = rc.id
        WHERE c.parent_id = #{parentId}
          AND c.post_id = #{postId}
        ORDER BY c.created_at ASC
    </select>

    <!-- 插入评论 -->
    <insert id="save" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO comment (post_id, user_id, parent_id, content, reply_to_user_id, reply_to_comment_id)
        VALUES (#{postId}, #{userId}, #{parentId}, #{content}, #{replyToUserId}, #{replyToCommentId})
    </insert>

    <!-- 根据ID查询评论 -->
    <select id="findById" resultType="com.linghang.we_talk.entity.Comment">
        SELECT * FROM comment WHERE id = #{id}
    </select>

    <!-- 统计一级评论数量 -->
    <select id="countRootComments" resultType="int">
        SELECT COUNT(*)
        FROM comment
        WHERE post_id = #{postId}
          AND parent_id IS NULL
    </select>

</mapper>